generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Workspace {
  id           String      @id @default(uuid()) @db.Uuid
  subdomain    String      @unique @db.VarChar(100)
  name         String      @db.VarChar(255)
  timezone     String      @default("UTC") @db.VarChar(50)
  currency     String      @default("USD") @db.VarChar(10)
  dateFormat   String      @default("DD.MM.YYYY") @map("date_format") @db.VarChar(20)
  storageLimit BigInt      @default(10737418240) @map("storage_limit")
  createdAt    DateTime    @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime    @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  users        User[]
  userGroups   UserGroup[]
  pipelines    Pipeline[]
  leads        Lead[]
  contacts     Contact[]
  companies    Company[]
  products     Product[]
  tasks        Task[]
  files        File[]
  messages     Message[]
  notes        Note[]
  customFields CustomField[]
  tags         Tag[]
  integrations Integration[]

  @@map("workspaces")
}

model User {
  id              String    @id @default(uuid()) @db.Uuid
  workspaceId     String    @map("workspace_id") @db.Uuid
  email           String    @db.VarChar(255)
  passwordHash    String    @map("password_hash") @db.VarChar(255)
  name            String?   @db.VarChar(255)
  phone           String?   @db.VarChar(50)
  avatarUrl       String?   @map("avatar_url")
  language        String    @default("es") @db.VarChar(10)
  twoFactorEnabled Boolean   @default(false) @map("two_factor_enabled")
  twoFactorSecret String?   @map("two_factor_secret") @db.VarChar(255)
  lastLogin       DateTime? @map("last_login") @db.Timestamptz
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  workspace       Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  assignedLeads   Lead[]    @relation("AssignedLeads")
  createdLeads    Lead[]    @relation("CreatedLeads")
  createdContacts Contact[] @relation("CreatedContacts")
  assignedContacts Contact[] @relation("AssignedContacts")
  createdCompanies Company[] @relation("CreatedCompanies")
  assignedCompanies Company[] @relation("AssignedCompanies")
  filesUploaded   File[]
  tasksAssigned   Task[]    @relation("AssignedTasks")
  tasksCreated    Task[]    @relation("CreatedTasks")
  authoredNotes   Note[]

  @@unique([workspaceId, email])
  @@map("users")
}

model UserGroup {
  id          String    @id @default(uuid()) @db.Uuid
  workspaceId String    @map("workspace_id") @db.Uuid
  name        String    @db.VarChar(100)
  description String?
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, name])
  @@map("user_groups")
}

// Permissions modeled slightly differently in Prisma usually, but keeping close to SQL
model Permission {
  id         String   @id @default(uuid()) @db.Uuid
  entityType String   @map("entity_type") @db.VarChar(50)
  action     String   @db.VarChar(50)
  scope      String   @default("global") @db.VarChar(50)
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz

  @@map("permissions")
}

model Pipeline {
  id           String          @id @default(uuid()) @db.Uuid
  workspaceId  String          @map("workspace_id") @db.Uuid
  name         String          @db.VarChar(255)
  templateType String          @default("custom") @map("template_type") @db.VarChar(50)
  isDefault    Boolean         @default(false) @map("is_default")
  createdAt    DateTime        @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime        @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  workspace    Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  stages       PipelineStage[]
  leads        Lead[]

  @@map("pipelines")
}

model PipelineStage {
  id          String   @id @default(uuid()) @db.Uuid
  pipelineId  String   @map("pipeline_id") @db.Uuid
  name        String   @db.VarChar(100)
  type        String   @db.VarChar(20)
  orderIndex  Int      @map("order_index")
  probability Decimal  @default(0.0) @db.Decimal(5, 2)
  color       String   @default("border-blue-400") @db.VarChar(50)
  bgColor     String   @default("bg-blue-50") @map("bg_color") @db.VarChar(50)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  pipeline    Pipeline @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  leads       Lead[]

  @@map("pipeline_stages")
}

model Lead {
  id             String         @id @default(uuid()) @db.Uuid
  workspaceId    String         @map("workspace_id") @db.Uuid
  pipelineId     String?        @map("pipeline_id") @db.Uuid
  currentStageId String?        @map("current_stage_id") @db.Uuid
  name           String         @db.VarChar(255)
  budget         Decimal?       @db.Decimal(15, 2)
  currency       String         @default("USD") @db.VarChar(10)
  source         String?        @db.VarChar(100)
  sourceId       String?        @map("source_id") @db.VarChar(255)
  assignedTo     String?        @map("assigned_to") @db.Uuid
  status         String         @default("active") @db.VarChar(20)
  createdBy      String?        @map("created_by") @db.Uuid
  createdAt      DateTime       @default(now()) @map("created_at") @db.Timestamptz
  updatedAt      DateTime       @default(now()) @updatedAt @map("updated_at") @db.Timestamptz
  closedAt       DateTime?      @map("closed_at") @db.Timestamptz

  workspace      Workspace      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  pipeline       Pipeline?      @relation(fields: [pipelineId], references: [id])
  currentStage   PipelineStage? @relation(fields: [currentStageId], references: [id])
  assignee       User?          @relation("AssignedLeads", fields: [assignedTo], references: [id])
  creator        User?          @relation("CreatedLeads", fields: [createdBy], references: [id])
  
  contactId      String?        @map("contact_id") @db.Uuid
  contact        Contact?       @relation(fields: [contactId], references: [id])
  
  tasks          Task[]
  messages       Message[]
  notes          Note[]

  @@index([workspaceId])
  @@index([assignedTo])
  @@index([status])
  @@map("leads")
}

model Contact {
  id          String   @id @default(uuid()) @db.Uuid
  workspaceId String   @map("workspace_id") @db.Uuid
  firstName   String?  @map("first_name") @db.VarChar(100)
  lastName    String?  @map("last_name") @db.VarChar(100)
  email       String?  @db.VarChar(255)
  phone       String?  @db.VarChar(50)
  position    String?  @db.VarChar(100)
  avatarUrl   String?  @map("avatar_url")
  notes       String?
  assignedTo  String?  @map("assigned_to") @db.Uuid
  createdBy   String?  @map("created_by") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  companyId   String?   @map("company_id") @db.Uuid
  company     Company?  @relation(fields: [companyId], references: [id])
  assignee    User?     @relation("AssignedContacts", fields: [assignedTo], references: [id])
  creator     User?     @relation("CreatedContacts", fields: [createdBy], references: [id])
  tasks       Task[]
  leads       Lead[]
  noteEntries Note[]
  messages    Message[]

  @@map("contacts")
}

model Company {
  id          String   @id @default(uuid()) @db.Uuid
  workspaceId String   @map("workspace_id") @db.Uuid
  name        String   @db.VarChar(255)
  email       String?  @db.VarChar(255)
  phone       String?  @db.VarChar(50)
  website     String?  @db.VarChar(255)
  address     String?
  industry    String?  @db.VarChar(100)
  size        String?  @db.VarChar(50)
  assignedTo  String?  @map("assigned_to") @db.Uuid
  createdBy   String?  @map("created_by") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  assignee    User?     @relation("AssignedCompanies", fields: [assignedTo], references: [id])
  creator     User?     @relation("CreatedCompanies", fields: [createdBy], references: [id])
  contacts    Contact[]
  tasks       Task[]
  notes       Note[]

  @@map("companies")
}

model Product {
  id                String   @id @default(uuid()) @db.Uuid
  workspaceId       String   @map("workspace_id") @db.Uuid
  sku               String   @db.VarChar(100)
  name              String   @db.VarChar(255)
  description       String?
  price             Decimal  @db.Decimal(15, 2)
  currency          String   @default("USD") @db.VarChar(10)
  cost              Decimal? @db.Decimal(15, 2)
  category          String?  @db.VarChar(100)
  unit              String   @default("unit") @db.VarChar(50)
  specialOfferPrice Decimal? @map("special_offer_price") @db.Decimal(15, 2)
  wholesalePrice    Decimal? @map("wholesale_price") @db.Decimal(15, 2)
  pointsPerPurchase Int      @default(0) @map("points_per_purchase")
  imageUrl          String?  @map("image_url")
  stock             Int?
  isActive          Boolean  @default(true) @map("is_active")
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  workspace         Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@map("products")
}

model Task {
  id                String    @id @default(uuid()) @db.Uuid
  workspaceId       String    @map("workspace_id") @db.Uuid
  title             String    @db.VarChar(255)
  description       String?
  type              String    @default("follow_up") @db.VarChar(50)
  status            String    @default("pending") @db.VarChar(20)
  priority          String    @default("medium") @db.VarChar(20)
  dueDate           DateTime? @map("due_date") @db.Timestamptz
  durationMinutes   Int?      @map("duration_minutes")
  assignedTo        String?   @map("assigned_to") @db.Uuid
  relatedLeadId     String?   @map("related_lead_id") @db.Uuid
  relatedContactId  String?   @map("related_contact_id") @db.Uuid
  relatedCompanyId  String?   @map("related_company_id") @db.Uuid
  createdBy         String?   @map("created_by") @db.Uuid
  completedAt       DateTime? @map("completed_at") @db.Timestamptz
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  workspace         Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  lead              Lead?     @relation(fields: [relatedLeadId], references: [id], onDelete: Cascade)
  contact           Contact?  @relation(fields: [relatedContactId], references: [id])
  company           Company?  @relation(fields: [relatedCompanyId], references: [id])
  assignee          User?     @relation("AssignedTasks", fields: [assignedTo], references: [id])
  creator           User?     @relation("CreatedTasks", fields: [createdBy], references: [id])

  @@index([dueDate])
  @@map("tasks")
}

model File {
  id               String   @id @default(uuid()) @db.Uuid
  workspaceId      String   @map("workspace_id") @db.Uuid
  filename         String   @db.VarChar(255)
  originalFilename String   @map("original_filename") @db.VarChar(255)
  mimeType         String?  @map("mime_type") @db.VarChar(100)
  sizeBytes        BigInt   @map("size_bytes")
  storagePath      String   @map("storage_path")
  uploadedBy       String?  @map("uploaded_by") @db.Uuid
  entityType       String?  @map("entity_type") @db.VarChar(50)
  entityId         String?  @map("entity_id") @db.Uuid
  source           String?  @db.VarChar(50)
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz

  workspace        Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  uploader         User?     @relation(fields: [uploadedBy], references: [id])

  @@index([entityType, entityId])
  @@map("files")
}

model Message {
  id               String   @id @default(uuid()) @db.Uuid
  workspaceId      String   @map("workspace_id") @db.Uuid
  channel          String   @db.VarChar(50)
  direction        String   @db.VarChar(10)
  fromAddress      String   @map("from_address")
  toAddress        String   @map("to_address")
  subject          String?  @db.VarChar(500)
  body             String?
  status           String   @default("sent") @db.VarChar(20)
  relatedLeadId    String?  @map("related_lead_id") @db.Uuid
  relatedContactId String?  @map("related_contact_id") @db.Uuid
  metadata         Json?
  sentAt           DateTime @default(now()) @map("sent_at") @db.Timestamptz
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz

  workspace        Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  lead             Lead?     @relation(fields: [relatedLeadId], references: [id], onDelete: Cascade)
  contact          Contact?  @relation(fields: [relatedContactId], references: [id])

  @@index([channel])
  @@map("messages")
}

model CustomField {
  id           String             @id @default(uuid()) @db.Uuid
  workspaceId  String             @map("workspace_id") @db.Uuid
  entityType   String             @map("entity_type") @db.VarChar(50)
  fieldName    String             @map("field_name") @db.VarChar(100)
  fieldType    String             @map("field_type") @db.VarChar(50)
  fieldOptions Json?              @map("field_options")
  isRequired   Boolean            @default(false) @map("is_required")
  orderIndex   Int                @default(0) @map("order_index")
  createdAt    DateTime           @default(now()) @map("created_at") @db.Timestamptz

  workspace    Workspace          @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  values       CustomFieldValue[]

  @@unique([workspaceId, entityType, fieldName])
  @@map("custom_fields")
}

model CustomFieldValue {
  id         String      @id @default(uuid()) @db.Uuid
  fieldId    String      @map("field_id") @db.Uuid
  entityType String      @map("entity_type") @db.VarChar(50)
  entityId   String      @map("entity_id") @db.Uuid
  fieldValue Json        @map("field_value")
  createdAt  DateTime    @default(now()) @map("created_at") @db.Timestamptz
  updatedAt  DateTime    @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  field      CustomField @relation(fields: [fieldId], references: [id], onDelete: Cascade)

  @@unique([fieldId, entityType, entityId])
  @@map("custom_field_values")
}

model Tag {
  id          String   @id @default(uuid()) @db.Uuid
  workspaceId String   @map("workspace_id") @db.Uuid
  name        String   @db.VarChar(100)
  color       String   @default("#6B7280") @db.VarChar(7)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz

  workspace   Workspace  @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  taggables   Taggable[]

  @@unique([workspaceId, name])
  @@map("tags")
}

model Taggable {
  id         String   @id @default(uuid()) @db.Uuid
  tagId      String   @map("tag_id") @db.Uuid
  entityType String   @map("entity_type") @db.VarChar(50)
  entityId   String   @map("entity_id") @db.Uuid
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz

  tag        Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([tagId, entityType, entityId])
  @@map("taggables")
}

model Integration {
  id          String    @id @default(uuid()) @db.Uuid
  workspaceId String    @map("workspace_id") @db.Uuid
  provider    String    @db.VarChar(50)
  status      String    @default("active") @db.VarChar(20)
  credentials Json
  config      Json?
  lastSync    DateTime? @map("last_sync") @db.Timestamptz
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@map("integrations")
}

model Note {
  id          String   @id @default(uuid()) @db.Uuid
  workspaceId String   @map("workspace_id") @db.Uuid
  content     String
  type        String   @default("user") @db.VarChar(50) // user, system, creation, update
  contactId   String?  @map("contact_id") @db.Uuid
  leadId      String?  @map("lead_id") @db.Uuid
  companyId   String?  @map("company_id") @db.Uuid
  createdBy   String?  @map("created_by") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  contact     Contact?  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  lead        Lead?     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  company     Company?  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  author      User?     @relation(fields: [createdBy], references: [id])

  @@map("notes")
}
